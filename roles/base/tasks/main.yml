---
- name: enable various settings
  sysctl:
    name: "{{ item }}"
    value: 1
    state: present
  loop:
      - kern.randompid
      - kern.msgbuf_show_timestamp
      - security.bsd.stack_guard_page
      - debug.kdb.break_to_debugger
      - kern.capmode_coredump
      - net.inet6.ip6.accept_rtadv
      - kern.sugid_coredump
      - kern.lognosys
      - kern.dtrace.err_verbose
  tags:
    - configuration

- name: set temperature offset for my machine
  sysctl:
    name: "dev.amdtemp.{{item}}.sensor_offset"
    value: -28
    state: present
  loop:
      - 0
      - 1
  tags:
    - configuration
    - hardware

- name: fail faster for deadlocks
  sysctl:
    name: "{{ item }}"
    value: 200
    state: present
  loop:
      - debug.deadlkres.blktime_threshold
      - debug.deadlkres.slptime_threshold
  tags:
    - configuration

- name: set kern.corefile for debugging
  sysctl:
    name: kern.corefile
    value: "/srv/cores/%N.%P.%U.%H.%I.core"
    state: present
  tags:
    - configuration

- name: disable witness
  sysctl:
    name: debug.witness.watch
    value: -1
    state: present
  tags:
    - configuration

- name: ensure proc is mounted
  mount:
    path: /proc
    fstype: procfs
    src: proc
    opts: rw,late
    state: mounted

- name: ensure linsysfs is mounted
  mount:
    path: /compat/linux/sys
    fstype: linsysfs
    src: linsysfs
    opts: rw,late
    state: mounted

- name: ensure linproc is mounted
  mount:
    path: /compat/linux/proc
    fstype: linprocfs
    src: linproc
    opts: rw,late
    state: mounted

- name: Install packages useful for base
  pkgng:
    name:
      - py36-ansible
      - zfs-stats
      - devcpu-data
      - xmbmon
      - bsdhwmon
      - beadm
      - drm-next-kmod
      - bsdstats
    state: present
  tags:
    - packages

- name: ensure fdesc is mounted
  mount:
    path: /dev/fd
    fstype: fdescfs
    src: fdescfs
    opts: rw,late
    state: mounted

- name: Load kernel modules
  kld:
    name: "{{ item }}"
    load: True
    boot: False
  tags:
    - configuration
    - hardware
  loop:
    - cpuctl
    - dtraceall
    - hwpmc
    - filemon
    - if_tap
    - amdtemp
    - tmpfs
    - linux
    - linux64
    - pf
    - nullfs
    - intpm
    - linprocfs
    - smbus
    - ksyms
    - vmm
    - nmdm
    - efirt
    - pflog
    - siftr
    - amdsbwd
    - iwm3160fw
    - if_iwm
#   - /boot/kernel/radeonkms.ko

- sysrc:
    name: microcode_update_enable
    value: YES
    state: present
  tags:
    - configuration
    - hardware
    - services

- sysrc:
    name: "{{ item }}"
    value: YES
    state: present
  loop:
    - rtsold_enable
    - local_unbound_enable
    - moused_enable
    - ntpd_enable
    - iocage_enable
    - zfsd_enable
  tags:
    - configuration
    - services

# --- Host configuration ---
- name: configure rc.conf
  blockinfile:
    path: /etc/rc.conf
    backup: yes
    block: |
      syslogd_flags="-ss"
      hostname="fasteagle"
      ifconfig_igb0="SYNCDHCP debug"
      ifconfig_igb0_ipv6="inet6 accept_rtadv wol"
      dumpdev="AUTO"
      wlans_iwm0="wlan0"
      ifconfig_wlan0="WPA DHCP indoor debug powersave ht -htcompat"
      cloned_interfaces="bridge0 tap0"
      ifconfig_bridge0="addm igb0 up"
      kld_list="cpuctl dtraceall hwpmc filemon if_tap amdtemp tmpfs linux linux64 pf nullfs intpm smbus ksyms vmm nmdm efirt pflog siftr amdsbwd iwm3160fw if_iwm /boot/kernel/radeonkms.ko"
    create: yes
    owner: root
    group: wheel
    marker: "# {mark} ANSIBLE MANAGED BLOCK :: basic"
    state: present
  notify:
    - restart kld
  tags:
    - configuration
    - networking
    - services

- name: loader config
  copy:
    src: loader.conf
    dest: /boot/loader.conf
    owner: root
    group: wheel
    mode: '0400'
    backup: yes
  tags:
    - configuration
    - logging


- name: syslog logging config
  copy:
    src: syslog.conf
    dest: /etc/syslog.conf
    owner: root
    group: wheel
    mode: '0444'
    backup: yes
  tags:
    - configuration
    - logging

- name: newsyslog config
  copy:
    src: newsyslog.conf
    dest: /etc/newsyslog.conf
    owner: root
    group: wheel
    mode: '0444'
    backup: yes
  tags:
    - configuration
    - logging

#- name: set up console and boot options
#  blockinfile:
#    path: /boot/loader.conf
#    backup: yes
#    block: |
#      boot_multicons="YES"
#      boot_serial="YES"
#      comconsole_speed="115200"
#      console="comconsole,efi"
#    create: yes
#    owner: root
#    group: wheel
#    state: present
#    marker: "# {mark} ANSIBLE MANAGED BLOCK :: console"
#  tags:
#    - configuration

- name: Set up local poudriere path
  template:
    src: poudriere.conf
    dest: /usr/local/etc/pkg/repos/poudriere.conf
    owner: root
    group: wheel
    mode: '0644'
    backup: yes
  tags:
    - configuration
    - poudriere

- name: set up wifi config
  template:
    src: wpa_supplicant.conf.j2
    dest: /etc/wpa_supplicant.conf
    owner: root
    group: wheel
    mode: '0644'
    backup: yes
  tags:
    - configuration
    - network

- import_tasks: qemu_host.yml
- import_tasks: jails.yml
- import_tasks: monitoring.yml
